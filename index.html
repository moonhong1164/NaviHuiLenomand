<!doctype html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NAVI&HUI LENORMAND</title>
<style>
:root{
  --bg:#efe7fb;            /* ì—°ë³´ë¼ ë°°ê²½ */
  --panel:#f6f1ff;         /* íŒ¨ë„ */
  --ink:#2c2343;           /* ë³¸ë¬¸ ê¸€ì */
  --muted:#6a5b8d;         /* ë³´ì¡° ê¸€ì */
  --accent:#6950cc;        /* íƒ€ì´í‹€ */
  --ring:#ded0ff;          /* ê²½ê³„ì„  */
  --chip:#e8ddff;          /* ì¹© ë°°ê²½ */
  --card-w: 240px;         /* ì¹´ë“œ ê¸°ë³¸ í­ (ìŠ¤ì¼€ì¼ ëŒ€ìƒ) */
  --radius:16px;
  --shadow:0 10px 30px rgba(28,17,63,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#ffffffcc,#ffffff77 70%,#fff0 100%);backdrop-filter:blur(6px);border-bottom:1px solid #fff6}
.container{max-width:1100px;margin:0 auto;padding:18px}
.title{font-size:28px;font-weight:800;letter-spacing:.3px;color:var(--accent)}.controls{background:var(--panel);border:1px solid var(--ring);border-radius:20px;padding:14px;box-shadow:var(--shadow);display:flex;flex-wrap:wrap;gap:10px;align-items:center} .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,.05)} .btn:active{transform:translateY(1px)} label.chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--ring);border-radius:999px;color:var(--muted);padding:8px 12px}

/* ì¹´ë“œ ê³µí†µ */ .card-mini{width:var(--card-w);background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:12px} .card-mini .img{width:100%;aspect-ratio:3/4;background:#c8b7f1;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden} .card-mini .img img{width:100%;height:100%;object-fit:contain} .card-mini h4{margin:10px 0 6px;font-size:18px} .card-mini p{margin:0;color:var(--muted)} .pin{position:absolute;width:14px;height:14px;border-radius:50%;right:10px;top:10px;box-shadow:0 1px 4px #0003} .pin.blue{background:#4091ff} .pin.green{background:#24c064} .pin.red{background:#ff4d6d} .card-mini{position:relative} .tone-chip{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:4px 10px;border-radius:999px;font-size:13px} .tone-pos{background:#e7f1ff;color:#0a5bd3} .tone-neg{background:#ffe7ee;color:#d2114a} .tone-neu{background:#e9f9ee;color:#0f8f4f}

/* ê²°ê³¼ ì¶œë ¥ ì˜ì—­ */ .result{margin-top:14px} .fitbox{width:100%;border-radius:18px;background:#fff;box-shadow:var(--shadow);border:1px solid var(--ring);padding:12px} .fitstage{transform-origin:top left;display:inline-block} .row-3,.row-5{display:flex;gap:12px} .cross-grid{display:grid;grid-template-columns:repeat(3,var(--card-w));gap:12px;justify-items:center} .cross-grid > div{display:flex;justify-content:center}

/* ê·¸ë‘íƒ€ë¸”ë¡œ */ .gt-wrap{display:grid;grid-template-columns:1fr;gap:16px} @media (min-width:1024px){.gt-wrap{grid-template-columns:1fr 320px}} .gt-grid{display:grid;gap:10px} .sidepanel{background:#fff;border:1px solid var(--ring);border-radius:18px;padding:12px;box-shadow:var(--shadow);color:var(--muted)} .gt-toolbar{color:var(--muted);margin:8px 0 6px}

/* ìš”ì•½(ì´í‰) ë°•ìŠ¤ */ .sumbox{background:#fff;border:1px solid var(--ring);border-radius:16px;padding:12px;margin-top:12px;box-shadow:var(--shadow)} .sum-title{font-weight:700;margin-bottom:4px} .sum-list{margin:6px 0 8px 16px} .sum-advice{color:var(--muted)}

/* ì¹´ë“œ ì „ì²´ ë³´ê¸° ê·¸ë¦¬ë“œ */ .allwrap{margin-top:14px} .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px} .hide{display:none} .note{font-size:12px;color:var(--muted)} footer{margin:28px 0 50px;color:var(--muted)} </style>

</head>
<body>
<header><div class="container"><div class="title">NAVI&HUI LENORMAND</div></div></header>
<main class="container">
  <section class="controls">
    <label class="chip"><input id="qToggle" type="checkbox"> ì§ˆë¬¸ ì…ë ¥</label>
    <input id="qInput" class="hide" type="search" placeholder="ì§ˆë¬¸(ì„ íƒ)" style="flex:1;min-width:180px;padding:8px 10px;border:1px solid var(--ring);border-radius:10px"/>
    <button class="btn" id="b1">ğŸƒ 1ì¹´ë“œ</button>
    <button class="btn" id="b3">ğŸƒğŸƒğŸƒ 3ì¹´ë“œ</button>
    <button class="btn" id="b5">ğŸƒğŸƒğŸƒğŸƒğŸƒ 5ì¹´ë“œ</button>
    <button class="btn" id="bx">â• ì‹­ì</button>
    <button class="btn" id="b94">ğŸ§© 9Ã—4</button>
    <button class="btn" id="b844">ğŸ§© 8Ã—4+4</button>
  </section>  <div id="questionBox" class="note hide" style="margin:8px 2px 0"></div>  <section id="result" class="result"></section>  <div style="margin-top:14px"><button class="btn" id="toggleAll">ğŸ“ ì¹´ë“œ ì „ì²´ ë³´ê¸°</button></div>
  <section id="all" class="allwrap hide">
    <div class="grid" id="allGrid"></div>
  </section>  <footer>ì œì‘ : ë‚˜ë¹„ğŸ¦‹, ì›”í™ğŸŒ™</footer>
</main><script>
// ======== ë°ì´í„° (ë²ˆí˜¸, ì½”ë“œ, í•œê¸€, í‚¤ì›Œë“œ, í†¤) ========
// type: 'positive' | 'negative' | 'neutral'
const CARDS = [
 {n:1, code:'Rider',   kr:'ê¸°ìˆ˜',    key:'ì†Œì‹Â·ë„ì°©Â·ì†ë„',          type:'neutral'},
 {n:2, code:'Clover',  kr:'í´ë¡œë²„',  key:'í–‰ìš´Â·ê¸°íšŒÂ·ì‘ì€ ì„±ê³¼',      type:'positive'},
 {n:3, code:'Ship',    kr:'ì„ ë°•',    key:'ì´ë™Â·ê±°ë˜Â·í™•ì¥',          type:'neutral'},
 {n:4, code:'House',   kr:'ì§‘',      key:'ê°€ì •Â·ì•ˆì •Â·ê¸°ë°˜ ë‹¤ì§€ê¸°',    type:'positive'},
 {n:5, code:'Tree',    kr:'ë‚˜ë¬´',    key:'ì„±ì¥Â·ê±´ê°•Â·ì¥ê¸°',           type:'positive'},
 {n:6, code:'Cloud',   kr:'êµ¬ë¦„',    key:'í˜¼ë€Â·ë¶ˆí™•ì‹¤Â·íŒë‹¨ ë³´ë¥˜',    type:'negative'},
 {n:7, code:'Snake',   kr:'ë±€',      key:'ì¥ì• Â·ìœ í˜¹Â·ê¸°ë§Œ',          type:'negative'},
 {n:8, code:'Coffin',  kr:'ê´€',      key:'ì¢…ê²°Â·ì „í™˜Â·ì •ë¦¬',           type:'negative'},
 {n:9, code:'Bouquet', kr:'ë¶€ì¼€',    key:'ê¸°ì¨Â·ì„ ë¬¼Â·í˜¸ì˜',           type:'positive'},
 {n:10,code:'Scythe',  kr:'ë‚«',      key:'ë‹¨ì ˆÂ·ê²°ë‹¨Â·ìˆ˜ìˆ ',           type:'neutral'},
 {n:11,code:'Whip',    kr:'ì±„ì°',    key:'ê°ˆë“±Â·ë°˜ë³µÂ·ë£¨í”„ ëŠê¸°',      type:'negative'},
 {n:12,code:'Bird',    kr:'ìƒˆ',      key:'ëŒ€í™”Â·ì†Œë¬¸Â·ì—°ë½',           type:'neutral'},
 {n:13,code:'Child',   kr:'ì•„ì´',    key:'ìƒˆ ì‹œì‘Â·ìˆœìˆ˜Â·ì‘ìŒ',        type:'positive'},
 {n:14,code:'Fox',     kr:'ì—¬ìš°',    key:'ì£¼ì˜Â·ì‚¬ìµÂ·ìŠ¤í‚¬',           type:'neutral'},
 {n:15,code:'Bear',    kr:'ê³°',      key:'ê¶Œí•œÂ·ìì›Â·ë³´í˜¸',           type:'positive'},
 {n:16,code:'Stars',   kr:'ë³„',      key:'ë¹„ì „Â·ì¸ì‚¬ì´íŠ¸Â·í‰íŒ',       type:'positive'},
 {n:17,code:'Stork',   kr:'í™©ìƒˆ',    key:'ë³€í™”Â·ì´ë™Â·ì—…ê·¸ë ˆì´ë“œ',    type:'positive'},
 {n:18,code:'Dog',     kr:'ê°œ',      key:'ì‹ ë¢°Â·ìš°ì •Â·íŒŒíŠ¸ë„ˆ',         type:'positive'},
 {n:19,code:'Tower',   kr:'íƒ‘',      key:'ì œë„Â·ê±°ë¦¬Â·ê´€ë¦¬',           type:'neutral'},
 {n:20,code:'Garden',  kr:'ì •ì›',    key:'ê³µê°œÂ·ëª¨ì„Â·PR',             type:'neutral'},
 {n:21,code:'Mountain',kr:'ì‚°',      key:'ì§€ì—°Â·ì¥ì• Â·ë²½',             type:'negative'},
 {n:22,code:'Crossroad',kr:'ê°ˆë¦¼ê¸¸', key:'ì„ íƒÂ·ê²°ì •Â·ë°ì´í„° ë¹„êµ',    type:'neutral'},
 {n:23,code:'Mice',    kr:'ì¥',      key:'ì†Œëª¨Â·ìŠ¤íŠ¸ë ˆìŠ¤Â·ê°ì†Œ',       type:'negative'},
 {n:24,code:'Heart',   kr:'í•˜íŠ¸',    key:'ì‚¬ë‘Â·ì—´ì •Â·í˜¸ê°',           type:'positive'},
 {n:25,code:'Ring',    kr:'ë°˜ì§€',    key:'ê³„ì•½Â·ìˆœí™˜Â·ì¥ê¸° ì»¤ë°‹',       type:'positive'},
 {n:26,code:'Book',    kr:'ì±…',      key:'ì§€ì‹Â·ë¹„ê³µê°œÂ·í•™ìŠµ',         type:'neutral'},
 {n:27,code:'Letter',  kr:'í¸ì§€',    key:'ë¬¸ì„œÂ·ì„œë¥˜Â·ì†Œì‹',           type:'neutral'},
 {n:28,code:'Man',     kr:'ë‚¨ì„±',    key:'í•µì‹¬ ì¸ë¬¼(ë‚¨)',           type:'neutral'},
 {n:29,code:'Woman',   kr:'ì—¬ì„±',    key:'í•µì‹¬ ì¸ë¬¼(ì—¬)',           type:'neutral'},
 {n:30,code:'Lily',    kr:'ë°±í•©',    key:'í‰í™”Â·ì„±ìˆ™Â·íœ´ì‹',           type:'positive'},
 {n:31,code:'Sun',     kr:'íƒœì–‘',    key:'ì„±ê³µÂ·í™œë ¥Â·ìŠ¹ë¦¬',           type:'positive'},
 {n:32,code:'Moon',    kr:'ë‹¬',      key:'ëª…ì˜ˆÂ·ê°ì •Â·ë¦¬ë“¬',           type:'neutral'},
 {n:33,code:'Key',     kr:'ì—´ì‡ ',    key:'í•´ê²°Â·ì •ë‹µÂ·ëŒíŒŒêµ¬',         type:'positive'},
 {n:34,code:'Fish',    kr:'ë¬¼ê³ ê¸°',  key:'ì¬ë¬¼Â·êµë¥˜Â·ê±°ë˜',           type:'neutral'},
 {n:35,code:'Anchor',  kr:'ë‹»',      key:'ì•ˆì •Â·ê³ ì •Â·ì§€ì†ì„±',         type:'positive'},
 {n:36,code:'Cross',   kr:'ì‹­ìê°€',  key:'ê³ ë‚œÂ·ì‹ ë…Â·ì±…ì„',           type:'negative'},
];
const byNum=new Map(CARDS.map(c=>[c.n,c]));
const IMG=(n)=>`images/ë ˆë…¸ë¨¼ë“œ-${String(n).padStart(2,'0')}.png`;

// ======== ë„ìš°ë¯¸ ========
const $=(sel,root=document)=>root.querySelector(sel);
const $$=(sel,root=document)=>[...root.querySelectorAll(sel)];
const result=$('#result');
const all=$('#all');
const allGrid=$('#allGrid');

function toneChip(type){
  if(type==='positive') return `<span class="tone-chip tone-pos">ğŸ”µ ê¸ì •</span>`;
  if(type==='negative') return `<span class="tone-chip tone-neg">ğŸ”´ ë¶€ì •</span>`;
  return `<span class="tone-chip tone-neu">ğŸŸ¢ ì¤‘ë¦½</span>`;
}
function pinClass(type){
  if(type==='positive') return 'green';
  if(type==='negative') return 'red';
  return 'blue';
}
function renderCard(c){
  return `<article class="card-mini">
    <span class="pin ${pinClass(c.type)}"></span>
    <div class="img"><img src="${IMG(c.n)}" alt="${c.n}. ${c.code}"></div>
    <h4><b>${c.n}. ${c.code}</b> (${c.kr})</h4>
    <p>${c.key}</p>
    ${toneChip(c.type)}
  </article>`;
}

// ìŠ¤ì¼€ì¼ í•: ë°•ìŠ¤ ì•ˆ(stage)ì„ transformìœ¼ë¡œ ì¶•ì†Œí•´ í™”ë©´ì— í•œ ë²ˆì— ë“¤ì–´ì˜¤ê²Œ
function fitToBox(box, stage, ratio=0.98){
  const bw=box.clientWidth-4, bh=Math.max(120, box.clientHeight-4);
  const rect=stage.getBoundingClientRect();
  const sw=rect.width, sh=rect.height;
  const sx=bw/sw, sy=bh/sh; // ì„¸ë¡œëŠ” box ë†’ì´ê°€ autoë¼ ì‹¤ì œë¡œëŠ” width ê¸°ì¤€ë§Œ ì‚¬ìš©
  const scale=Math.min(sx, ratio);
  stage.style.transform=`scale(${scale})`;
}
function fitAfterImages(box,stage,ratio){
  const imgs=$$('img',stage);
  const wait=imgs.map(im=>im.complete?Promise.resolve():new Promise(res=>{im.addEventListener('load',res,{once:true});im.addEventListener('error',res,{once:true});}));
  Promise.all(wait).then(()=>{
    const run=()=>{fitToBox(box,stage,ratio)};
    run(); requestAnimationFrame(run); setTimeout(run,200); setTimeout(run,500);
    addEventListener('resize',run,{passive:true});
    window.visualViewport?.addEventListener('resize',run,{passive:true});
  });
}

// ì§ˆë¬¸ í‘œì‹œ
const qToggle=$('#qToggle');
const qInput=$('#qInput');
const qBox=$('#questionBox');
qToggle.addEventListener('change',()=>{
  qInput.classList.toggle('hide',!qToggle.checked);
  if(!qToggle.checked) qInput.value='';
});
function ensureQuestion(){
  if(qToggle.checked && qInput.value.trim()){
    qBox.textContent=`ì§ˆë¬¸: ${qInput.value.trim()}`; qBox.classList.remove('hide');
  } else { qBox.classList.add('hide'); qBox.textContent=''; }
}

// ======== ì´í‰ ìƒì„± ========
function countTones(cards){
  const r={ê¸ì •:0,ë¶€ì •:0,ì¤‘ë¦½:0};
  cards.forEach(c=>{ if(c.type==='positive') r.ê¸ì •++; else if(c.type==='negative') r.ë¶€ì •++; else r.ì¤‘ë¦½++; });
  return r;
}
function leadFromCounts(cnt){ return Object.entries(cnt).sort((a,b)=>b[1]-a[1])[0][0]; }
function emojiFor(lead){ return lead==='ê¸ì •'?'ğŸ”µ':lead==='ë¶€ì •'?'ğŸ”´':'ğŸŸ¢'; }
function adviceFor(lead){
  if(lead==='ê¸ì •') return 'ìš°í˜¸ì  íë¦„ì…ë‹ˆë‹¤. ë“¤ì–´ì˜¨ ì œì•ˆ/ì—°ë½ì„ í™œìš©í•´ ì†ë„ë¥¼ ì‚´ë ¤ ë³´ì„¸ìš”.';
  if(lead==='ë¶€ì •') return 'ë¦¬ìŠ¤í¬ ê´€ë¦¬ ìš°ì„ . ì¼ì •Â·ìì›Â·ë¬¸ì„œ(ê³„ì•½) ì²´í¬ í›„ ì†ë„ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.';
  return 'í˜¼í•© ì—ë„ˆì§€ì…ë‹ˆë‹¤. ì •ë³´ ë³´ê°•ê³¼ ì¼ì • ì¡°ì •ìœ¼ë¡œ ê· í˜•ì„ ë§ì¶”ì„¸ìš”.';
}
function spreadSummary(cards, title='ì „ì²´ í†¤'){
  const cnt=countTones(cards), lead=leadFromCounts(cnt), em=emojiFor(lead);
  const bullets = cards.map(c=>`<li>${c.n}. ${c.code} â€” ${c.key}</li>`).join('');
  return `<div class="sumbox">
    <div class="sum-title">${title}: ${em} <b>${lead}</b>
      <span class="sum-note"> (ê¸ì • ${cnt.ê¸ì •} / ë¶€ì • ${cnt.ë¶€ì •} / ì¤‘ë¦½ ${cnt.ì¤‘ë¦½})</span></div>
    <ul class="sum-list">${bullets}</ul>
    <div class="sum-advice"><b>ê¶Œê³ :</b> ${adviceFor(lead)}</div>
  </div>`;
}

// ======== ëœë¤ ë½‘ê¸° ========
function pickN(n){
  const arr=[...CARDS];
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
  return arr.slice(0,n);
}

function renderRow(cards, cols, summaryTitle){
  result.innerHTML=`
    <div class="fitbox"><div class="fitstage" id="rowStage">
      <div class="${cols===3?'row-3':'row-5'}" style="width:${cols*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-w'))}px">
        ${cards.map(renderCard).join('')}
      </div>
    </div></div>
    ${summaryTitle?spreadSummary(cards,summaryTitle):''}
  `;
  fitAfterImages($('.fitbox'),$('#rowStage'),.98);
}

function draw1(){ ensureQuestion(); const cs=pickN(1); renderRow(cs,3,'1ì¹´ë“œ í†¤'); }
function draw3(){ ensureQuestion(); const cs=pickN(3); renderRow(cs,3,'3ì¹´ë“œ í†¤'); }
function draw5(){ ensureQuestion(); const cs=pickN(5); renderRow(cs,5,'5ì¹´ë“œ í†¤'); }

// ì‹­ì (ì¤‘ì•™/ìƒ/ì¢Œ/ìš°/í•˜) + ìš”ì•½
function drawCross(){
  ensureQuestion();
  const [C,Up,Down,Left,Right]=pickN(5);
  const cards=[Up,Left,C,Right,Down];
  result.innerHTML = `
    <div class="fitbox"><div class="fitstage" id="crossStage">
      <div class="cross-grid">
        <div></div><div>${renderCard(Up)}</div><div></div>
        <div>${renderCard(Left)}</div><div>${renderCard(C)}</div><div>${renderCard(Right)}</div>
        <div></div><div>${renderCard(Down)}</div><div></div>
      </div>
    </div></div>
    ${spreadSummary(cards,'ì‹­ì ìŠ¤í”„ë ˆë“œ í†¤')}
  `;
  fitAfterImages($('.fitbox'),$('#crossStage'),.98);
}

// ê·¸ë‘íƒ€ë¸”ë¡œ (9x4 or 8x4+4)
function renderEssSummary(essNums){
  if(!essNums.length) return '';
  const cards=essNums.map(n=>byNum.get(n));
  return spreadSummary(cards,'ì—ì„¼ìŠ¤ 4ì¥ í†¤');
}
function grandTableau(cols,rows,withEssence){
  ensureQuestion();
  const order=pickN(36).map(c=>c.n);
  const mainNums=order.slice(0, cols*rows);
  const essNums = withEssence? order.slice(cols*rows) : [];

  const mainHTML = `
    <div class="gt-toolbar">ì¹´ë“œë¥¼ ëˆŒëŸ¬ <b>í‚¤ ì¹´ë“œ</b>ì˜ ì£¼ìœ„ ì¹´ë“œì™€ <b>ë‚˜ì´íŒ…</b>ì„ í™•ì¸í•˜ì„¸ìš”.</div>
    <div class="fitbox" id="gtMainBox"><div class="fitstage" id="gtStage">
      <div class="gt-grid" style="grid-template-columns:repeat(${cols},var(--card-w))">
        ${mainNums.map((n,i)=>{const c=byNum.get(n);return `
          <article class=\"card-mini gt\" data-idx=\"${i}\" data-num=\"${n}\">
            <span class=\"pin ${pinClass(c.type)}\"></span>
            <div class=\"img\"><img src=\"${IMG(n)}\" alt=\"\"></div>
            <h4><b>${c.n}. ${c.code}</b> (${c.kr})</h4>
            <p>${c.key}</p>
            ${toneChip(c.type)}
          </article>`;}).join('')}
      </div>
    </div></div>`;

  const essHTML = withEssence ? `
    <div class="gt-toolbar"><b>ì—ì„¼ìŠ¤ 4ì¥</b></div>
    <div class="fitbox" id="gtEssBox"><div class="fitstage" id="gtEss">
      <div class="gt-grid" style="grid-template-columns:repeat(4,var(--card-w))">
        ${essNums.map(n=>{const c=byNum.get(n);return `
          <article class=\"card-mini\">
            <span class=\"pin ${pinClass(c.type)}\"></span>
            <div class=\"img\"><img src=\"${IMG(n)}\" alt=\"\"></div>
            <h4><b>${c.n}. ${c.code}</b> (${c.kr})</h4>
            <p>${c.key}</p>
            ${toneChip(c.type)}
          </article>`;}).join('')}
      </div>
    </div></div>
    ${renderEssSummary(essNums)}
  ` : '';

  result.innerHTML = `<div class="gt-wrap">
    <div>${mainHTML}${essHTML}</div>
    <aside id="gtInfo" class="sidepanel">í‚¤ ì¹´ë“œë¥¼ ì„ íƒí•˜ë©´ í•´ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</aside>
  </div>`;

  // í´ë¦­ ì‹œ ì£¼ìœ„/ë‚˜ì´íŒ… ê³„ì‚°
  const gridEl = document.querySelector('#gtStage .gt-grid');
  const toIdx=(r,c)=> (r>=0&&r<rows&&c>=0&&c<cols)? r*cols+c : -1;
  gridEl.querySelectorAll('.gt').forEach(el=>{
    el.addEventListener('click',()=>{
      const idx=+el.dataset.idx, r=Math.floor(idx/cols), c=idx%cols;
      const around=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].map(([dr,dc])=>toIdx(r+dr,c+dc)).filter(i=>i>=0);
      const knight=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].map(([dr,dc])=>toIdx(r+dr,c+dc)).filter(i=>i>=0);
      const getNum=i=>+gridEl.querySelector(`.gt[data-idx="${i}"]`).dataset.num;
      const fmt=a=>a.map(n=>`${n}. ${byNum.get(n).code}`).join(', ')||'ì—†ìŒ';
      const me=byNum.get(+el.dataset.num);
      $('#gtInfo').innerHTML = `<b>í‚¤ ì¹´ë“œ:</b> ${me.n}. ${me.code} (${me.kr}) â€” ${me.key}<br>
        <b>ì£¼ìœ„ ì¹´ë“œ:</b> ${fmt(around.map(getNum))}<br>
        <b>ë‚˜ì´íŒ…:</b> ${fmt(knight.map(getNum))}`;
    },{passive:true});
  });

  // ì¶•ì†Œ ë§ì¶¤
  const mainBox=$('#gtMainBox'), mainStage=$('#gtStage');
  const essBox = withEssence? $('#gtEssBox'):null;
  const essStage = withEssence? $('#gtEss'):null;
  const imgs=[...$$('img',mainStage), ...(withEssence? $$('img',essStage):[])];
  const run=()=>{fitToBox(mainBox,mainStage,.96); if(withEssence) fitToBox(essBox,essStage,.96);} 
  const wait=imgs.map(im=>im.complete?Promise.resolve():new Promise(res=>{im.addEventListener('load',res,{once:true}); im.addEventListener('error',res,{once:true});}));
  Promise.all(wait).then(()=>{ run(); requestAnimationFrame(run); setTimeout(run,200); setTimeout(run,600); });
  addEventListener('resize',run,{passive:true});
  window.visualViewport?.addEventListener('resize',run,{passive:true});
}

// ======== ì¹´ë“œ ì „ì²´ ë³´ê¸° ========
function buildAll(){
  allGrid.innerHTML = CARDS.map(renderCard).join('');
}

// ======== ì´ë²¤íŠ¸ ========
$('#b1').addEventListener('click',draw1);
$('#b3').addEventListener('click',draw3);
$('#b5').addEventListener('click',draw5);
$('#bx').addEventListener('click',drawCross);
$('#b94').addEventListener('click',()=>grandTableau(9,4,false));
$('#b844').addEventListener('click',()=>grandTableau(8,4,true));

$('#toggleAll').addEventListener('click',()=>{
  all.classList.toggle('hide');
  if(!all.classList.contains('hide')) buildAll();
});

// ì´ˆê¸°ì—ëŠ” ì•„ë¬´ ìŠ¤í”„ë ˆë“œë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
</script>
</body>
</html>